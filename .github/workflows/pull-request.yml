name: CI
run-name: Pull to ${{ github.base_ref }} by ${{ github.actor }}

on:
  pull_request:
    branches: [master, develop, 3.x]

jobs:
  Unit-Tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['5.6', '7.1', '7.2', '7.3', '7.4']
    steps:
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
      - name: Setup MySQL
        uses: shogo82148/actions-setup-mysql@v1
        with:
          mysql-version: '5.6'
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Install dependencies
        run: composer require 'cakephp/cakephp=3.10.5'
        shell: bash
      #- name: Setup CakePHP
      #  uses: ./.github/actions/setup-cakephp
      #- name: Setup database
      #  uses: ./.github/actions/setup-database
      - name: Create test database
        run: mysql -u root -e "CREATE DATABASE cakephp_test"
        shell: bash
      - name: Install PHPUnit
        run: composer require 'phpunit/phpunit=5.7'
      #  run: |
      #    cd ./cakephp
      #    composer require 'phpunit/phpunit=5.7'
      #    cd ../

      - name: Unit Tests
        run: ./vendor/bin/phpunit ./tests

  PHP-Lint:
    runs-on: ubuntu-latest
    steps:
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 7.4
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Install PHPLint
        run: composer require --dev overtrue/phplint
      - name: Run PHPLint
        run: vendor/bin/phplint

  PHPStan:
    runs-on: ubuntu-latest
    steps:
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 7.4
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Setup CakePHP
        uses: ./.github/actions/setup-cakephp
      - name: Install PHPUnit
        run: composer require 'phpunit/phpunit=7.0'
      - name: Install PHPStan
        run: |
          composer require --dev phpstan/phpstan
          composer require --dev phpstan/phpstan-phpunit
      - name: PHPStan
        run: vendor/bin/phpstan analyse --level=8 ./src ./tests
