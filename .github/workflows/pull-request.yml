name: CI
run-name: Pull to ${{ github.base_ref }} by ${{ github.actor }}

on:
  pull_request:
    branches: [master, develop]

jobs:
  Unit-Tests:
    runs-on: ubuntu-latest
    steps:
      - name: Install PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
      - name: Install MySQL
        uses: shogo82148/actions-setup-mysql@v1
        with:
          mysql-version: '5.6'
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Clone CakePHP
        uses: actions/checkout@v3
        with: 
          repository: cakephp/cakephp
          path: ./cakephp
          ref: 2.10.14
        run: |
          cd ./cakephp
          chmod -R 777 app/tmp
          composer require 'phpunit/phpunit=5.7'
          cd ../
      - name: Fix composer autoload
        run: |
          echo "<?php " > /tmp/core.php
          echo "require ROOT . '/vendors/autoload.php'; " >> /tmp/core.php
          echo "spl_autoload_unregister(array('App', 'load')); " >> /tmp/core.php
          echo "spl_autoload_register(array('App', 'load'), true, true); " >> /tmp/core.php
          echo "?>" >> /tmp/core.php
          cat ./cakephp/app/Config/core.php >> /tmp/core.php
          cp /tmp/core.php ./cakephp/app/Config/core.php
      - name: Copy plugin files to plugins folder
        run: |
          mkdir -p ./cakephp/plugins/Filter
          cp -R ./Controller ./cakephp/plugins/Filter/Controller
          cp -R ./Model ./cakephp/plugins/Filter/Model
          cp -R ./Test ./cakephp/plugins/Filter/Test
          cp -R ./View ./cakephp/plugins/Filter/View
      - name: Setup database
        run: |
          cp ./cakephp/app/Config/database.php.default ./cakephp/app/Config/database.php
          mysql -e "CREATE DATABASE test_database_name"
          mysql -e "CREATE USER 'user'@'%' IDENTIFIED BY 'password'"
          mysql -u root -e "GRANT ALL PRIVILEGES ON test_database_name.* TO 'user'@'%'"
      - name: Unit Tests
        run: ./cakephp/lib/Cake/Console/cake test Filter All --stderr -app ./cakephp/app

